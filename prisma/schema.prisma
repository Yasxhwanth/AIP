// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ── Core Organization ──────────────────────────────────────────────────

model Project {
  id          String   @id @default(uuid())
  name        String
  description String?
  createdAt   DateTime @default(now())

  entityTypes      EntityType[]
  dataSources      DataSource[]
  integrationJobs  IntegrationJob[]
  decisionRules    DecisionRule[]
  modelDefinitions ModelDefinition[]
  dashboards       Dashboard[]
  pipelines        Pipeline[]
  apiKeys          ApiKey[]
}

model EntityType {
  id        String   @id @default(uuid())
  name      String
  version   Int
  createdAt DateTime @default(now())

  attributes            AttributeDefinition[]
  instances             EntityInstance[]
  outgoingRelationships RelationshipDefinition[]   @relation("RelationshipSource")
  incomingRelationships RelationshipDefinition[]   @relation("RelationshipTarget")
  integrationJobs       IntegrationJob[]
  computedMetrics       ComputedMetricDefinition[]
  modelDefinitions      ModelDefinition[]
  decisionRules         DecisionRule[]
  currentStates         CurrentEntityState[]

  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, name, version])
  @@index([projectId])
}

model AttributeDefinition {
  id       String  @id @default(uuid())
  name     String
  dataType String
  required Boolean
  temporal Boolean @default(false)

  entityTypeId String
  entityType   EntityType @relation(fields: [entityTypeId], references: [id], onDelete: Restrict)
}

model RelationshipDefinition {
  id        String   @id @default(uuid())
  name      String
  createdAt DateTime @default(now())

  sourceEntityTypeId String
  targetEntityTypeId String

  sourceEntityType EntityType @relation("RelationshipSource", fields: [sourceEntityTypeId], references: [id], onDelete: Restrict)
  targetEntityType EntityType @relation("RelationshipTarget", fields: [targetEntityTypeId], references: [id], onDelete: Restrict)

  instances RelationshipInstance[]

  @@index([sourceEntityTypeId])
  @@index([targetEntityTypeId])
}

model RelationshipInstance {
  id                       String @id @default(uuid())
  relationshipDefinitionId String
  sourceLogicalId          String
  targetLogicalId          String
  properties               Json?

  validFrom       DateTime
  validTo         DateTime?
  transactionTime DateTime  @default(now())

  relationshipDef RelationshipDefinition @relation(fields: [relationshipDefinitionId], references: [id])

  @@index([sourceLogicalId, validFrom, validTo])
  @@index([targetLogicalId, validFrom, validTo])
  @@index([relationshipDefinitionId, sourceLogicalId, targetLogicalId])
}

model EntityInstance {
  id            String @id @default(uuid())
  logicalId     String
  entityTypeId  String
  entityVersion Int
  data          Json

  // Identity & Trust
  confidenceScore Float  @default(1.0)
  reviewStatus    String @default("APPROVED") // PENDING, APPROVED, REJECTED, MERGED

  validFrom       DateTime
  validTo         DateTime?
  transactionTime DateTime  @default(now())

  entityType        EntityType         @relation(fields: [entityTypeId], references: [id], onDelete: Restrict)
  provenanceRecords ProvenanceRecord[]

  @@index([entityTypeId, logicalId])
  @@index([validFrom, validTo, transactionTime])
}

model EntityAlias {
  id              String @id @default(uuid())
  externalId      String // The ID from the source system (e.g. OpenSky callsign)
  sourceSystem    String // e.g. "OPENSKY", "ADSB_EXCHANGE"
  targetLogicalId String // The platform's logicalId this maps to

  confidence Float   @default(1.0)
  isPrimary  Boolean @default(false)

  createdAt DateTime @default(now())

  @@unique([sourceSystem, externalId])
  @@index([targetLogicalId])
}

// ── Entity Resolution: Fuzzy Match Candidates ──────────────────────

model MatchCandidate {
  id             String   @id @default(uuid())
  logicalIdA     String   // Candidate entity A (canonical logicalId)
  logicalIdB     String   // Candidate entity B
  entityTypeId   String   // Both candidates must be same entity type
  scoreOverall   Float    // 0.0 – 1.0 composite similarity score
  scoreBreakdown Json     // { "name": 0.9, "address": 0.7, ... }
  matchReasons   Json     // ["same_name_fuzzy", "same_lat_lon", ...]
  status         String   @default("PENDING") // PENDING | MERGED | REJECTED
  reviewedBy     String?  // apiKeyName of the reviewer
  reviewedAt     DateTime?
  mergedIntoId   String?  // logicalId this was merged into (when MERGED)
  sourceJobId    String?  // which integration job triggered this
  createdAt      DateTime @default(now())

  @@unique([logicalIdA, logicalIdB, entityTypeId])
  @@index([entityTypeId, status])
  @@index([logicalIdA])
  @@index([logicalIdB])
}

model MatchResolutionHistory {
  id               String   @id @default(uuid())
  matchCandidateId String   @unique
  logicalIdA       String
  logicalIdB       String
  entityTypeId     String
  
  // The state of the candidate when the decision was made
  scoreOverall     Float
  scoreBreakdown   Json
  matchReasons     Json

  // The decision made by human/system
  resolution       String   // MERGED | REJECTED
  resolvedBy       String
  resolvedAt       DateTime @default(now())

  @@index([entityTypeId, resolution])
  @@index([resolvedAt])
}

// ── Audit Log ─────────────────────────────────────────────────────

model AuditLog {
  id           String   @id @default(uuid())
  actor        String   // apiKeyName or "system"
  actorRole    String   // role at time of action
  action       String   // e.g. "CREATE_ENTITY", "MERGE_CANDIDATE", "EXECUTE_DECISION"
  resourceType String   // e.g. "EntityType", "MatchCandidate", "DecisionLog"
  resourceId   String?  // id of the affected resource
  before       Json?    // state before (for mutating operations)
  after        Json?    // state after
  metadata     Json?    // request metadata (IP, correlationId, etc)
  occurredAt   DateTime @default(now())

  @@index([actor, occurredAt(sort: Desc)])
  @@index([resourceType, resourceId, occurredAt(sort: Desc)])
  @@index([action, occurredAt(sort: Desc)])
}

model ProvenanceRecord {
  id               String   @id @default(uuid())
  entityInstanceId String
  attributeName    String? // Null means the entire record, otherwise specific field
  sourceSystem     String
  sourceRecordId   String // The ID in the external system for this specific data point
  sourceTimestamp  DateTime
  ingestedAt       DateTime @default(now())

  entityInstance EntityInstance @relation(fields: [entityInstanceId], references: [id], onDelete: Cascade)

  @@index([entityInstanceId, attributeName])
}

// ── Epic 2: Data Lineage & Contracts ──────────────────────────────
model LineageEdge {
  id               String   @id @default(uuid())
  sourceType       String   // e.g. "IntegrationJob", "PipelineNode", "ModelDefinition"
  sourceId         String   // ID of the upstream source
  targetType       String   // e.g. "EntityType", "Field", "ConsumerApp"
  targetId         String   // ID of the downstream consumer/field
  transformation   String?  // Description of what changed the data (e.g. "mapped via fieldMapping")
  
  createdAt        DateTime @default(now())

  @@unique([sourceType, sourceId, targetType, targetId])
  @@index([sourceType, sourceId])
  @@index([targetType, targetId])
}

model DomainEvent {
  id             String   @id @default(uuid())
  idempotencyKey String?  @unique
  eventType      String
  entityTypeId   String
  logicalId      String
  entityVersion  Int
  payload        Json
  occurredAt     DateTime @default(now())

  @@index([entityTypeId, logicalId])
  @@index([eventType])
  @@index([occurredAt])
}

model PolicyDefinition {
  id           String   @id @default(uuid())
  name         String   @unique
  description  String?
  entityTypeId String
  eventType    String   @default("EntityStateChanged")
  condition    Json // { "field": "temperature", "operator": ">", "value": 100 }
  actionType   String   @default("EmitAlert")
  actionConfig Json? // { "alertType": "HighTemperatureAlert", "severity": "critical" }
  version      Int      @default(1)
  enabled      Boolean  @default(true)
  createdAt    DateTime @default(now())

  @@index([entityTypeId, eventType])
}

// ── Epic 4: Governance & Compliance ───────────────────────────────

model AbacPolicy {
  id           String   @id @default(uuid())
  name         String   @unique
  description  String?
  action       String   // e.g. "READ", "WRITE", "DELETE", "*"
  resourceType String   // e.g. "EntityType", "MatchCandidate", "*"
  effect       String   @default("ALLOW") // "ALLOW" or "DENY"
  condition    Json?    // ABAC rule definition (e.g. { "req.user.clearance": ">=", "resource.classification" })
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([action, resourceType])
}

model Alert {
  id              String   @id @default(uuid())
  alertType       String
  severity        String   @default("warning")
  policyId        String
  policyVersion   Int?
  eventId         String?
  entityTypeId    String
  logicalId       String
  payload         Json
  evaluationTrace Json?
  acknowledged    Boolean  @default(false)
  createdAt       DateTime @default(now())

  @@unique([eventId, policyId])
  @@index([entityTypeId, logicalId])
  @@index([alertType])
  @@index([createdAt])
}

// ── CQRS Read Models (Projections) ───────────────────────────────

model CurrentEntityState {
  logicalId    String   @id
  entityTypeId String
  data         Json
  legalHold    Boolean  @default(false)
  updatedAt    DateTime

  entityType   EntityType @relation(fields: [entityTypeId], references: [id], onDelete: Cascade)

  @@index([entityTypeId])
}

model CurrentGraph {
  id                       String @id @default(uuid())
  relationshipDefinitionId String
  relationshipName         String
  sourceLogicalId          String
  targetLogicalId          String
  properties               Json?

  // Probabilistic Relationship Decay
  confidence               Float    @default(1.0) // Current computed or asserted confidence (0.0-1.0)
  baseConfidence           Float    @default(1.0) // Initial confidence at inference time
  decayRate                Float    @default(0.0) // e.g. 0.05 (5%) decay per day. 0 = no decay
  lastObservedAt           DateTime @default(now())

  @@unique([relationshipDefinitionId, sourceLogicalId, targetLogicalId])
  @@index([sourceLogicalId])
  @@index([targetLogicalId])
}

// ── Time-Series & Telemetry ────────────────────────────────────────

model TimeseriesMetric {
  id        String   @id @default(uuid())
  logicalId String // The entity this metric belongs to
  metric    String // e.g., "temperature", "pressure"
  value     Float
  timestamp DateTime @default(now())

  // Optimize for: "Get all 'temperature' readings for 'asset-001' over time X to Y"
  @@index([logicalId, metric, timestamp(sort: Desc)])
}

// ── Data Integration Layer ─────────────────────────────────────────

model DataSource {
  id               String   @id @default(uuid())
  name             String   @unique
  type             String // REST_API, JSON_UPLOAD, CSV_UPLOAD
  connectionConfig Json // { url, headers, auth, ... }
  enabled          Boolean  @default(true)
  createdAt        DateTime @default(now())

  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  integrationJobs IntegrationJob[]

  @@index([projectId])
}

model Pipeline {
  id          String   @id @default(uuid())
  name        String
  description String?
  nodes       Json // ReactFlow nodes
  edges       Json // ReactFlow edges
  enabled     Boolean  @default(true)
  createdAt    DateTime @default(now())

  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
}

model IntegrationJob {
  id                 String   @id @default(uuid())
  name               String   @unique
  dataSourceId       String
  targetEntityTypeId String
  fieldMapping       Json // { "external_field": "ontology_attribute", ... }
  logicalIdField     String // Which external field becomes logicalId
  schedule           String? // Cron expression for polling (null = manual only)
  enabled            Boolean  @default(true)
  createdAt          DateTime @default(now())

  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  dataSource       DataSource     @relation(fields: [dataSourceId], references: [id], onDelete: Restrict)
  targetEntityType EntityType     @relation(fields: [targetEntityTypeId], references: [id], onDelete: Restrict)
  executions       JobQueue[]

  @@index([projectId])
  @@index([dataSourceId])
  @@index([targetEntityTypeId])
}

// ── Epic 1: Orchestration & Reliability Queue ─────────────────────

model JobWorker {
  id             String   @id @default(uuid())
  hostname       String
  pid            Int
  status         String   @default("ACTIVE") // ACTIVE, DRAINING, OFFLINE
  lastHeartbeat  DateTime @default(now())
  startedAt      DateTime @default(now())

  @@index([status, lastHeartbeat(sort: Desc)])
}

model JobQueue {
  id               String    @id @default(uuid())
  jobType          String    // e.g., "INTEGRATION_SYNC", "SCHEMA_INFERENCE", "BACKFILL"
  status           String    @default("QUEUED") // QUEUED, RUNNING, COMPLETED, FAILED, DEAD_LETTER
  priority         Int       @default(0) // Higher number = higher priority
  
  // Payload & Idempotency
  payload          Json      // The actual instructions/data for the job
  idempotencyKey   String?   @unique
  
  // Execution tracking
  startedAt        DateTime?
  completedAt      DateTime?
  lockedAt         DateTime?
  lockedByWorkerId String?   // References JobWorker.id
  
  // Retry & DLQ Semantics
  attempts         Int       @default(0)
  maxAttempts      Int       @default(3)
  nextAttemptAt    DateTime? 
  lastError        String?
  
  // Metrics (mapped from old JobExecution)
  recordsProcessed Int       @default(0)
  recordsFailed    Int       @default(0)
  
  // Optional References to parent definitions
  integrationJobId String?
  integrationJob   IntegrationJob? @relation(fields: [integrationJobId], references: [id], onDelete: Cascade)
  
  // Parent/Child DAG dependencies
  parentJobId      String?
  parentJob        JobQueue?  @relation("JobDependencies", fields: [parentJobId], references: [id])
  childJobs        JobQueue[] @relation("JobDependencies")

  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@index([status, nextAttemptAt])
  @@index([jobType, status])
  @@index([integrationJobId, startedAt(sort: Desc)])
}

// ── Computed Metrics & Transforms ──────────────────────────────────

model ComputedMetricDefinition {
  id           String   @id @default(uuid())
  name         String
  entityTypeId String
  expression   String // e.g., "output / input * 100"
  unit         String? // e.g., "%", "kW"
  enabled      Boolean  @default(true)
  createdAt    DateTime @default(now())

  entityType EntityType @relation(fields: [entityTypeId], references: [id], onDelete: Restrict)

  @@unique([entityTypeId, name])
  @@index([entityTypeId])
}

model TelemetryRollup {
  id          String   @id @default(uuid())
  logicalId   String
  metric      String
  windowSize  String // "5m", "1h", "1d"
  windowStart DateTime
  avg         Float
  min         Float
  max         Float
  sum         Float
  count       Int

  @@unique([logicalId, metric, windowSize, windowStart])
  @@index([logicalId, metric, windowSize, windowStart(sort: Desc)])
}

// ── ML Model Registry & Inference ─────────────────────────────────

model ModelDefinition {
  id           String   @id @default(uuid())
  name         String   @unique
  entityTypeId String
  description  String?
  inputFields  Json // ["temperature", "pressure", "vibration"]
  outputField  String // e.g., "anomalyScore"
  createdAt    DateTime @default(now())

  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  entityType EntityType     @relation(fields: [entityTypeId], references: [id], onDelete: Restrict)
  versions   ModelVersion[]

  @@index([projectId])
  @@index([entityTypeId])
}

model ModelVersion {
  id                String   @id @default(uuid())
  modelDefinitionId String
  version           Int
  status            String   @default("DRAFT") // DRAFT, STAGING, PRODUCTION, RETIRED, SHADOW
  strategy          String // THRESHOLD, ANOMALY_ZSCORE, LINEAR_REGRESSION, CUSTOM
  hyperparameters   Json // Strategy-specific config
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  modelDefinition  ModelDefinition   @relation(fields: [modelDefinitionId], references: [id], onDelete: Cascade)
  inferenceResults InferenceResult[]
  driftMetrics     ModelDriftMetric[]
  latencyMetrics   ModelLatencyMetric[]

  @@unique([modelDefinitionId, version])
  @@index([modelDefinitionId, status])
}

model ModelDriftMetric {
  id             String   @id @default(uuid())
  modelVersionId String
  featureName    String   // which input feature drifted
  metricType     String   // JENSEN_SHANNON, KS_STATISTIC, WASSERSTEIN
  value          Float    // the calculated drift score
  referenceStart DateTime // the time window of the baseline data
  referenceEnd   DateTime
  currentStart   DateTime // the time window of the evaluated data
  currentEnd     DateTime
  createdAt      DateTime @default(now())

  modelVersion ModelVersion @relation(fields: [modelVersionId], references: [id], onDelete: Cascade)

  @@index([modelVersionId, featureName, createdAt(sort: Desc)])
}

model ModelLatencyMetric {
  id             String   @id @default(uuid())
  modelVersionId String
  windowStart    DateTime // the start of the bucket (e.g., 5 min window)
  windowSize     String   // "5m", "1h"
  p50            Float    // median latency in ms
  p90            Float
  p95            Float
  p99            Float
  avg            Float
  requestCount   Int
  errorCount     Int      @default(0)
  createdAt      DateTime @default(now())

  modelVersion ModelVersion @relation(fields: [modelVersionId], references: [id], onDelete: Cascade)

  @@index([modelVersionId, windowStart(sort: Desc)])
}

model InferenceResult {
  id             String   @id @default(uuid())
  modelVersionId String
  logicalId      String
  input          Json
  output         Json
  confidence     Float?
  createdAt      DateTime @default(now())

  modelVersion ModelVersion @relation(fields: [modelVersionId], references: [id], onDelete: Cascade)

  @@index([modelVersionId, createdAt(sort: Desc)])
  @@index([logicalId, createdAt(sort: Desc)])
}

// ── Decision & Execution Engine ───────────────────────────────

model DecisionRule {
  id                  String   @id @default(uuid())
  name                String   @unique
  entityTypeId        String
  conditions          Json // [{ field, operator, value }]
  logicOperator       String   @default("AND") // AND | OR
  priority            Int      @default(100) // lower = higher priority
  autoExecute         Boolean  @default(false) // true = skip approval
  confidenceThreshold Float? // only fire if inference confidence >= this
  enabled             Boolean  @default(true)
  createdAt           DateTime @default(now())

  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  entityType     EntityType      @relation(fields: [entityTypeId], references: [id], onDelete: Restrict)
  executionPlans ExecutionPlan[]
  decisionLogs   DecisionLog[]

  @@index([projectId])
  @@index([entityTypeId, enabled])
}

model ActionDefinition {
  id        String   @id @default(uuid())
  name      String   @unique
  type      String // WEBHOOK, UPDATE_ENTITY, CREATE_ALERT, RUN_INFERENCE, LOG_ONLY
  config    Json // type-specific: { url, headers, fields, severity, ... }
  createdAt DateTime @default(now())

  executionPlans ExecutionPlan[]
}

model ExecutionPlan {
  id                 String  @id @default(uuid())
  decisionRuleId     String
  actionDefinitionId String
  stepOrder          Int
  continueOnFailure  Boolean @default(false)

  decisionRule     DecisionRule     @relation(fields: [decisionRuleId], references: [id], onDelete: Cascade)
  actionDefinition ActionDefinition @relation(fields: [actionDefinitionId], references: [id], onDelete: Cascade)

  @@unique([decisionRuleId, stepOrder])
  @@index([decisionRuleId, stepOrder])
}

model DecisionLog {
  id               String   @id @default(uuid())
  decisionRuleId   String
  logicalId        String
  triggerType      String // INFERENCE, STATE_CHANGE, MANUAL, SIMULATION
  triggerData      Json // snapshot of input data
  conditionResults Json // per-condition evaluation details
  decision         String // EXECUTE, PENDING_APPROVAL, SKIPPED, SIMULATED
  executionResults Json? // per-step action results
  status           String   @default("PENDING") // COMPLETED, FAILED, PENDING, SIMULATED
  createdAt        DateTime @default(now())

  decisionRule DecisionRule @relation(fields: [decisionRuleId], references: [id], onDelete: Cascade)

  @@index([decisionRuleId, createdAt(sort: Desc)])
  @@index([logicalId, createdAt(sort: Desc)])
}

// ── Enterprise: Authentication ───────────────────────────────────

model ApiKey {
  id         String    @id @default(uuid())
  name       String
  keyHash    String    @unique // SHA-256 hash
  role       String    @default("VIEWER") // ADMIN, OPERATOR, VIEWER
  rateLimit  Int       @default(100) // requests per minute
  enabled    Boolean   @default(true)
  lastUsedAt DateTime?
  createdAt  DateTime  @default(now())
  
  projectId  String?   // For tenant isolation
  project    Project?  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  @@index([projectId])
}

// ── UI Dashboard Builder ─────────────────────────────────────────

model Dashboard {
  id        String   @id @default(uuid())
  projectId String
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  widgets DashboardWidget[]

  @@index([projectId])
}

model DashboardWidget {
  id          String @id @default(uuid())
  dashboardId String
  type        String // e.g., "TELEMETRY", "MAP", "ONTOLOGY_GRAPH", "DATA_INTEGRATION"
  configData  Json // Widget specific config (e.g. which entity or metric to show)

  // React-Grid-Layout properties
  x Int // Grid X position
  y Int // Grid Y position
  w Int // Grid width
  h Int // Grid height

  dashboard Dashboard @relation(fields: [dashboardId], references: [id], onDelete: Cascade)

  @@index([dashboardId])
}
